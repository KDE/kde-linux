#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2023-2024 Harald Sitter <sitter@kde.org>

set -ex

[ -f /etc/initrd-release ] || false

sysroot=/sysroot
rootdisk=/dev/disk/by-partlabel/KDEOS

mount -v -o subvol=/ "$rootdisk" "${sysroot}/system"

mount -v \
    -o subvol=@home \
    "$rootdisk" "${sysroot}/home"
mount -v \
    -o subvol=@snap \
    "$rootdisk" "${sysroot}/snap"
mount -v \
    -t overlay \
    -o "lowerdir=${sysroot}/etc,upperdir=${sysroot}/system/@etc-overlay/upper,workdir=${sysroot}/system/@etc-overlay/work,index=off,metacopy=off" \
    overlay "${sysroot}/etc"
mount -v \
    -t overlay \
    -o "lowerdir=${sysroot}/var,upperdir=${sysroot}/system/@var-overlay/upper,workdir=${sysroot}/system/@var-overlay/work,index=off,metacopy=off" \
    overlay "${sysroot}/var"
