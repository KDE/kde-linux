#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2023-2024 Harald Sitter <sitter@kde.org>

set -ex

. /etc/os-release

kernel_version=""
for f in /usr/lib/modules/*/vmlinuz
do
  kernel_version="$(basename "$(dirname "$f")")"
done

# NOTE: plymouth MUST be after systemd as per the wiki!
cat <<- EOF > /etc/mkinitcpio.conf
MODULES=(overlay)
BINARIES=()
FILES=()
HOOKS=(base systemd autodetect modconf kms keyboard block sd-encrypt filesystems fsck systemd-extension plymouth)
EOF

echo "rw rootflags=subvol=@kdeos_$IMAGE_VERSION systemd.volatile=overlay systemd.firstboot=false systemd.hostname=kdeos kdeos.live=1 plasma.live.user=live \
  lsm=landlock,lockdown,yama,integrity,apparmor,bpf \
  quiet splash" > cmdline
mkinitcpio --generate initrd --kernel "$kernel_version"
ukify build \
  --linux /boot/vmlinuz-linux \
  --initrd initrd \
  --cmdline @cmdline \
  --output live.efi

# lsm= defaulting to apparmor from https://wiki.archlinux.org/title/AppArmor
echo "rw rootflags=subvol=@kdeos_$IMAGE_VERSION \
  lsm=landlock,lockdown,yama,integrity,apparmor,bpf \
  quiet splash" > cmdline
mkinitcpio --generate initrd --kernel "$kernel_version"
ukify build \
  --linux /boot/vmlinuz-linux \
  --initrd initrd \
  --cmdline @cmdline \
  --output kdeos.efi
