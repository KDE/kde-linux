#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2023-2024 Harald Sitter <sitter@kde.org>

set -ex

. /etc/os-release

kernel_version=""
for f in /usr/lib/modules/*/vmlinuz
do
  kernel_version="$(basename "$(dirname "$f")")"
done

# NOTE: plymouth MUST be after systemd as per the wiki!
cat <<- EOF > /etc/mkinitcpio.conf
MODULES=(overlay)
BINARIES=()
FILES=()
HOOKS=(base systemd autodetect modconf kms keyboard block sd-encrypt filesystems fsck systemd-extension plymouth)
EOF

echo "native ro root=PARTLABEL=KDEOSLive systemd.volatile=overlay systemd.firstboot=false systemd.hostname=kdeos kdeos.live=1 \
  rd.systemd.debug_shell=on systemd.debug_shell=on SYSTEMD_SULOGIN_FORCE=1 \
  console=ttyS0 console=tty0 \
  systemd.log_level=debug systemd.log_target=kmsg log_buf_len=1M printk.devkmsg=on \
  splash" > cmdline
mkinitcpio --generate initrd --kernel "$kernel_version"
ukify build \
  --linux /boot/vmlinuz-linux \
  --initrd initrd \
  --cmdline @cmdline \
  --output live.efi

# lsm= defaulting to apparmor from https://wiki.archlinux.org/title/AppArmor
echo "native ro root=PARTLABEL=KDEOS rootflags=subvol=@kdeos_$IMAGE_VERSION \
  lsm=landlock,lockdown,yama,integrity,apparmor,bpf \
  rd.systemd.debug_shell=on systemd.debug_shell=on SYSTEMD_SULOGIN_FORCE=1 \
  console=ttyS0 console=tty0 \
  systemd.log_level=debug systemd.log_target=kmsg log_buf_len=1M printk.devkmsg=on \
  splash" > cmdline
mkinitcpio --generate initrd --kernel "$kernel_version"
ukify build \
  --linux /boot/vmlinuz-linux \
  --initrd initrd \
  --cmdline @cmdline \
  --output kdeos.efi

