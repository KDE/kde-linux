#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2025 Harald Sitter <sitter@kde.org>

set -eu

. /etc/os-release

if [ ! -b /dev/gpt-auto-root ]; then
    echo "gpt-auto-root does not exist"
    exit 1
fi

if [ -d /run/kde-linux-rootfs-transition ]; then
    exit 0
fi

mkdir /run/kde-linux-rootfs-transition
mount -o rw,subvol=/ /dev/gpt-auto-root /run/kde-linux-rootfs-transition

# Check if we need RootFSv2 migration
if [ ! -e /run/kde-linux-rootfs-transition/@system ]; then
    # RootFSv2 migration needed
    if [ ! -e "/run/kde-linux-rootfs-transition/kde-linux_$IMAGE_VERSION.erofs" ]; then
        echo "kde-linux_$IMAGE_VERSION.erofs does not exist on root partition. Aborting transition."
        systemctl reboot
        exit 1
    fi
    _kde-linux-btrfs-migrator /run/kde-linux-rootfs-transition
fi

# Check if we need RootFSv3 migration (missing @home or @home/.snapshots)
if [ ! -e /run/kde-linux-rootfs-transition/@home ] || \
   [ ! -e /run/kde-linux-rootfs-transition/@home/.snapshots ]; then
    echo "RootFSv3 migration needed - creating missing @home structure"
    _kde-linux-btrfs-migrator-v3 /run/kde-linux-rootfs-transition
fi

/usr/lib/btrfs-migrator /run/kde-linux-rootfs-transition
umount --recursive --lazy /run/kde-linux-rootfs-transition
