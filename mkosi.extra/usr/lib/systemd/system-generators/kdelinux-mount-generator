#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-only OR GPL-3.0-only OR LicenseRef-KDE-Accepted-GPL
# SPDX-FileCopyrightText: 2024 Harald Sitter <sitter@kde.org>

set -eux

. /usr/lib/os-release

normal_dir=$1
# shellcheck disable=SC2034
early_dir=$2
# shellcheck disable=SC2034
late_dir=$3

cat <<- EOF > "$normal_dir/var-lib-extensions-debug.mount"
# Generated by $(basename "$0")
[Unit]
Description=Mount unit for /var/lib/extensions/debug
Before=systemd-sysext.service
After=var.mount

[Mount]
What=/system/@kdeos_debug_${BUILD_ID}
Where=/var/lib/extensions/debug
Type=none
Options=bind,nodev,x-gdu.hide,x-gvfs-hide

[Install]
WantedBy=systemd-sysext.service
EOF

mkdir "$normal_dir/systemd-sysext.service.wants/"
ln -s ../var-lib-extensions-debug.mount "$normal_dir/systemd-sysext.service.wants/var-lib-extensions-debug.mount"
