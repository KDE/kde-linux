# SPDX-License-Identifier: BSD-2-Clause
# SPDX-FileCopyrightText: None

include:
  - project: sysadmin/ci-utilities
    file:
      - /gitlab-templates/reuse-lint.yml
      - /gitlab-templates/blocks/workflow.yml

stages:
  - validate
  - test_isotovideo
  - start
  #- test_isotovideo

test-latest-build_isotovideo:
  stage: test_isotovideo
  tags:
    - LinuxHighMemory
  allow_failure: false
  when: manual
  image:
    name: registry.opensuse.org/devel/openqa/containers/isotovideo:qemu-x86
    entrypoint: ["/bin/bash", "-c"]

  variables:
    IMAGE_VERSION: latest

  before_script:
    - git clone https://invent.kde.org/anicaazhu/os-autoinst-distri-kdelinux.git
    - cd os-autoinst-distri-kdelinux
    - zypper --non-interactive install perl-Inline-Python python3-requests python3-beautifulsoup4 ffmpeg
    - python3 utils/download_image.py --$IMAGE_VERSION

  script:
    - .gitlab/scripts/isotovideo/latest_build_test.sh

  after_script:
    - .gitlab/scripts/isotovideo/collect_results.sh
  artifacts:
    when: always
    paths:
      - reports/

imaging:
  stage: start
  tags:
    - VM
    - amd64
  rules:
    - if: $CI_MERGE_REQUEST_DRAFT == "true"
      when: manual
    - if: $CI_COMMIT_BRANCH =~ /^work\//
      when: manual
    - if: $CI_COMMIT_REF_PROTECTED != 'true' || $CI_DEFAULT_BRANCH != $CI_COMMIT_REF_NAME || $CI_PROJECT_PATH != 'kde-linux/kde-linux'
      when: always

  allow_failure: false
  image: storage.kde.org/vm-images/kde-linux-builder
  variables: &variables
    RUNNER_AFTER_SCRIPT_TIMEOUT: 1h
  script:
    - sudo ./build.sh --force --debug # bootstap.sh happens as part of CI image build
  after_script:
    # Upload all images to Harald. You can grab them at http://images.kde-linux.haraldsitter.eu/
    - ./upload-to-harald.sh || true

imaging+publish:
  stage: start
  tags:
    - VM
    - amd64
  rules:
    # NOTE: these are different from the regular imaging job!
    - if: $CI_COMMIT_REF_PROTECTED == 'true' && $CI_DEFAULT_BRANCH == $CI_COMMIT_REF_NAME && $CI_PROJECT_PATH == 'kde-linux/kde-linux'
      when: always
  allow_failure: false
  image: storage.kde.org/vm-images/kde-linux-builder
  variables: *variables
  script:
    - sudo pacman --sync --refresh --noconfirm curl which git
    - curl -s https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer | bash
    - sudo ./build.sh --force --debug # bootstap.sh happens as part of CI image build
    - ./upload.sh
  after_script:
    # Upload broken images to Harald for inspection
    - "[ $CI_JOB_STATUS == 'success' ] || ./upload-to-harald.sh || true"
